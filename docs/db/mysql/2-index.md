# MySQL 索引

## 存储引擎

### InnoDB存储引擎

- InnoDB的主键索引采用的是聚集索引，叶子节点存放的是索引值和对应的数据记录
- InnoDB的辅助索引采用的是非聚集索引，叶子节点存放的是索引值和对应的主键
- 使用InnoDB引擎的数据表，**.ibd**文件包含了该表的索引和数据

### MyISAM存储引擎

- MyISAM采用的是非聚集索引，即索引文件和数据文件是分离的
- 无论是主键索引还是辅助索引，叶子节点存放的都是索引值和对应数据的磁盘地址
- 使用MyISAM引擎的数据表，**.MYI**文件存放了表的索引，**.MYD**文件存放了表的数据记录

### InnoDB和MyISAM的查找过程 

![](https://hfut-xyc.gitee.io/image/mysql-search.png)

### 覆盖索引

- 在InnoDB存储引擎中，用辅助索引查找时，可能要用第1次查找得到的主键，再去主键索引中进行第2次查找，称之为回表查询
- 如果要查找的字段就是`主键值或者辅助索引的索引字段`，则不需要回表，称之为覆盖索引

## 创建索引的注意事项

### 单列索引

- 单列索引即由一列属性组成的索引。

### 联合索引(union key)

- 联合索引即由多列属性组成索引。

- 在创建联合索引时，尽量把查询最频繁的那个字段作为最左字段，查询的时候也尽量以该字段为第一条件。

### 冗余索引(redundant key)

- 如果创建了索引(A, B)，再创建索引(A)就是冗余索引，能够命中后者的查询肯定也能命中前者
- 在大多数情况下，都应该尽量扩展已有的索引而不是创建新索引。

### 索引失效和查询优化

假设数据表存在一个联合索引 **(a, b, c)** 

  |                  where语句查询条件                  |   是否命中索引   |
  | :-------------------------------------------------: | :--------------: |
  |                    where a  =  1                    |      命中a       |
  |                where a = 1 and b = 2                |     命中a, b     |
  |           where a = 1 and b = 2 and c = 3           |   命中a, b, c    |
  |                where a = 1 and c = 3                |  命中a，未命中c  |
  | where b = 2 或 where c = 3 或 where b = 2 and c = 3 |    未命中索引    |
  |         where a = 1 and **b > 2** and c = 3         | 命中a,b，未命中c |
  |   where a = 1 and **b between 2 and 4** and c = 3   | 命中a,b，未命中c |
  |     where a = 1 and **b like test%**  and c = 3     | 命中a,b，未命中c |

  

在索引列使用 like 进行字符串模糊查询时，以%开头的形式无法命中索引

``` java
  SELECT * FROM tb_user WHERE name LIKE '%a';
  SELECT * FROM tb_user WHERE name LIKE '%a%';
  SELECT * FROM tb_user WHERE name LIKE 'a%'; // 只有这种写法才能命中索引
```

在索引列使用 **!=、is null、is not null、in、not in**查询时，索引都会失效

在索引列使用 **表达式、函数**时，索引会失效

在索引列查询出现**类型转换**时，索引会失效

使用or查询**可能**会使索引失效

``` java
  
```

## InnoDB的Page结构

### 页的大小和数量

- InnoDB存储引擎的`最小存储单元是页`，页可以用于存放`数据行`也可以用于存放`索引值+指针`。
- 在主键索引树中，叶子节点存放数据，非叶子节点存放键值+指针

- page的默认大小为16KB，假设一行数据记录的大小为1KB
- 一个叶子节点（页）中存放的记录数最多为 16KB / 1KB  =  16
- 假设主键id为`bigint`类型，长度为`8字节`，而指针大小在InnoDB源码中设置为`6字节`，共14字节
- 一个非叶子节点中存放的指针数最多为 16 * 1024Bytes / 14 Bytes  =  1170
- 高度为2的B+树，大约能存放 1170 * 16   =  18720 条记录
- 高度为3的B+树，大约能存放 1170 * 1170 * 16   =  21902400 条记录